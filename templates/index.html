<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word2Vec Training & Analysis Tool</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #4e73df;
            --secondary-color: #1cc88a;
            --dark-color: #2e59d9;
            --light-color: #f8f9fc;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fc;
            color: #5a5c69;
        }
        
        .navbar {
            background-color: var(--primary-color);
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        }
        
        .navbar-brand {
            font-weight: 700;
            color: white;
        }
        
        .card {
            border: none;
            border-radius: 0.35rem;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
            margin-bottom: 1.5rem;
        }
        
        .card-header {
            background-color: white;
            border-bottom: 1px solid #e3e6f0;
            font-weight: 700;
            color: var(--primary-color);
            padding: 0.75rem 1.25rem;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--dark-color);
            border-color: var(--dark-color);
        }
        
        .btn-success {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .step-icon {
            width: 50px;
            height: 50px;
            background-color: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        
        .step-content {
            flex: 1;
        }
        
        .upload-area {
            border: 2px dashed #d1d3e2;
            border-radius: 0.35rem;
            padding: 2rem;
            text-align: center;
            background-color: #f8f9fc;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: var(--primary-color);
            background-color: #eef2ff;
        }
        
        .upload-area.dragover {
            border-color: var(--primary-color);
            background-color: #eef2ff;
        }
        
        .file-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid #e3e6f0;
        }
        
        .file-item:last-child {
            border-bottom: none;
        }
        
        .progress {
            height: 10px;
        }
        
        .processing-step {
            display: none;
        }
        
        .spinner-border {
            width: 1.5rem;
            height: 1.5rem;
        }
        
        .result-item {
            padding: 10px 15px;
            border-bottom: 1px solid #e3e6f0;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .footer {
            text-align: center;
            padding: 20px 0;
            margin-top: 40px;
            color: #858796;
            font-size: 0.9rem;
            border-top: 1px solid #e3e6f0;
        }
        
        .tab-content {
            padding: 20px 0;
        }
        
        .heatmap-container {
            width: 100%;
            overflow-x: auto;
            margin-top: 20px;
        }
        
        .heatmap {
            border-collapse: collapse;
            margin: 0 auto;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
        }
        
        .heatmap-cell {
            width: 40px;
            height: 40px;
            text-align: center;
            font-size: 11px;
            border: 1px solid #e3e6f0;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .heatmap-cell:hover {
            transform: scale(1.1);
            z-index: 10;
            position: relative;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        
        .heatmap-header {
            background-color: #f8f9fc;
            font-weight: 700;
            color: var(--primary-color);
            padding: 10px;
            text-align: center;
        }
        
        .category-builder {
            border: 1px solid #e3e6f0;
            border-radius: 0.35rem;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .category-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background-color: #f8f9fc;
            border-radius: 4px;
        }
        
        .category-item:hover {
            background-color: #eef2ff;
        }
        
        .word-input {
            display: flex;
            margin-bottom: 10px;
        }
        
        .word-input input {
            flex: 1;
            margin-right: 10px;
        }
        
        .word-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #e3e6f0;
            border-radius: 4px;
        }
        
        .word-tag {
            display: inline-block;
            background-color: #e9ecef;
            padding: 3px 8px;
            margin: 2px;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        .word-tag .remove {
            margin-left: 5px;
            cursor: pointer;
            color: #6c757d;
        }
        
        .word-tag .remove:hover {
            color: #dc3545;
        }
        
        .similarity-results {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .alert {
            margin-bottom: 1rem;
        }
        
        .color-scale {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        
        .color-bar {
            height: 20px;
            flex: 1;
            background: linear-gradient(90deg, #ffffff, #4e73df);
            border-radius: 3px;
            margin: 0 10px;
        }
        
        .color-labels {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 5px;
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .download-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .tooltip-inner {
            max-width: 300px;
        }
        
        .heatmap-legend {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px 0;
        }
        
        .results-summary {
            background: #f8f9fc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .small-upload {
            padding: 1rem;
        }
        
        .small-upload i {
            font-size: 1.5rem;
        }
        
        .small-upload p {
            margin-bottom: 0.5rem;
        }
        
        .category-management {
            margin-top: 20px;
        }
        
        .category-card {
            border: 1px solid #e3e6f0;
            border-radius: 0.35rem;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .category-header {
            background-color: #f8f9fc;
            padding: 10px 15px;
            border-bottom: 1px solid #e3e6f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .category-words {
            padding: 10px 15px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .empty-state {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 10px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-brain me-2"></i>Word2Vec Training & Analysis Tool
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="training-tab" data-bs-toggle="tab" data-bs-target="#training" type="button" role="tab">
                    <i class="fas fa-cogs me-2"></i>Model Training
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="analysis-tab" data-bs-toggle="tab" data-bs-target="#analysis" type="button" role="tab">
                    <i class="fas fa-chart-bar me-2"></i>Vector Analysis
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="heatmap-tab" data-bs-toggle="tab" data-bs-target="#heatmap" type="button" role="tab">
                    <i class="fas fa-th me-2"></i>Heatmap Generator
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="mainTabsContent">
            <!-- Training Tab -->
            <div class="tab-pane fade show active" id="training" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Word2Vec Training Pipeline</h5>
                            </div>
                            <div class="card-body">
                                <!-- Step 1: Upload Files -->
                                <div class="step">
                                    <div class="step-icon">1</div>
                                    <div class="step-content">
                                        <h5>Upload Text or PDF Files</h5>
                                        <p>Upload one or multiple text or PDF files to process through the Word2Vec training pipeline.</p>
                                        
                                        <div class="upload-area" id="uploadArea">
                                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                            <h5>Drag & Drop Files Here</h5>
                                            <p class="text-muted">or click to browse</p>
                                            <input type="file" id="fileInput" multiple accept=".txt,.pdf" style="display: none;">
                                            <button class="btn btn-primary mt-2" id="browseBtn">Browse Files</button>
                                        </div>
                                        
                                        <div class="mt-3" id="fileListContainer" style="display: none;">
                                            <h6>Selected Files:</h6>
                                            <div class="file-list card" id="fileList">
                                                <!-- Files will be listed here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Step 2: Processing -->
                                <div class="step processing-step" id="processingStep">
                                    <div class="step-icon">2</div>
                                    <div class="step-content">
                                        <h5>Processing Files</h5>
                                        <p>Your files are being processed through the Word2Vec training pipeline.</p>
                                        
                                        <div class="progress mb-3">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                                 role="progressbar" style="width: 0%" id="progressBar"></div>
                                        </div>
                                        
                                        <div id="processingStatus">
                                            <div class="d-flex align-items-center">
                                                <div class="spinner-border text-primary me-2" role="status"></div>
                                                <span>Initializing...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Step 3: Results -->
                                <div class="step processing-step" id="resultsStep" style="display: none;">
                                    <div class="step-icon">3</div>
                                    <div class="step-content">
                                        <h5>Processing Complete</h5>
                                        <p>Your Word2Vec model has been trained successfully.</p>
                                        
                                        <div class="card mt-3">
                                            <div class="card-header bg-success text-white">
                                                <i class="fas fa-check-circle me-2"></i>Results Ready
                                            </div>
                                            <div class="card-body">
                                                <div class="results-summary">
                                                    <h6>Generated Files:</h6>
                                                    <ul class="list-group">
                                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                                            <div>
                                                                <i class="fas fa-file-csv text-success me-2"></i>
                                                                phrase_counts.csv
                                                            </div>
                                                            <span class="badge bg-primary rounded-pill">Phrase frequencies</span>
                                                        </li>
                                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                                            <div>
                                                                <i class="fas fa-file-code text-info me-2"></i>
                                                                word_vectors.emb
                                                            </div>
                                                            <span class="badge bg-primary rounded-pill">Word embeddings</span>
                                                        </li>
                                                    </ul>
                                                </div>
                                                <div class="download-options">
                                                    <button class="btn btn-success" id="downloadBtn">
                                                        <i class="fas fa-download me-2"></i>Download All Results (ZIP)
                                                    </button>
                                                    <button class="btn btn-outline-primary" id="previewResultsBtn">
                                                        <i class="fas fa-eye me-2"></i>Preview Results
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Action Buttons -->
                                <div class="d-flex justify-content-between mt-4">
                                    <button class="btn btn-outline-secondary" id="resetBtn" disabled>
                                        <i class="fas fa-redo me-2"></i>Reset
                                    </button>
                                    <button class="btn btn-primary" id="processBtn" disabled>
                                        <i class="fas fa-cogs me-2"></i>Process Files
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Analysis Tab -->
            <div class="tab-pane fade" id="analysis" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Upload Embedding File</h5>
                            </div>
                            <div class="card-body">
                                <div class="upload-area" id="embUploadArea">
                                    <i class="fas fa-file-code fa-3x text-muted mb-3"></i>
                                    <h5>Upload .emb File</h5>
                                    <p class="text-muted">Drag & drop or click to browse</p>
                                    <input type="file" id="embFileInput" accept=".emb" style="display: none;">
                                    <button class="btn btn-primary mt-2" id="embBrowseBtn">Browse .emb File</button>
                                </div>
                                <div class="mt-3" id="embFileInfo" style="display: none;">
                                    <div class="alert alert-success">
                                        <i class="fas fa-check-circle me-2"></i>
                                        <span id="embFileName"></span> loaded successfully
                                        <div class="mt-2">
                                            <small>Words loaded: <span id="wordCount">0</span></small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-4">
                            <div class="card-header">
                                <h5 class="mb-0">Word Similarity Search</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="searchWord" class="form-label">Enter a word to find similar words:</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="searchWord" placeholder="e.g., system">
                                        <button class="btn btn-primary" id="searchBtn" disabled>Search</button>
                                    </div>
                                </div>
                                <div id="similarityResults" class="similarity-results" style="display: none;">
                                    <h6>Similar words:</h6>
                                    <div id="similarWordsList"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Vector Visualization</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="word1" class="form-label">Word 1:</label>
                                    <input type="text" class="form-control" id="word1" placeholder="Enter word">
                                </div>
                                <div class="mb-3">
                                    <label for="word2" class="form-label">Word 2:</label>
                                    <input type="text" class="form-control" id="word2" placeholder="Enter word">
                                </div>
                                <div class="mb-3">
                                    <label for="word3" class="form-label">Word 3:</label>
                                    <input type="text" class="form-control" id="word3" placeholder="Enter word">
                                </div>
                                <button class="btn btn-primary" id="visualizeBtn" disabled>Visualize Similarity</button>
                                <div class="mt-3" id="visualizationContainer" style="display: none;">
                                    <canvas id="similarityChart" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Heatmap Tab -->
            <div class="tab-pane fade" id="heatmap" role="tabpanel">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Upload Embedding File</h5>
                            </div>
                            <div class="card-body">
                                <div class="upload-area small-upload" id="embUploadAreaHeatmap">
                                    <i class="fas fa-file-code fa-2x text-muted mb-2"></i>
                                    <p class="text-muted mb-1">Upload .emb file</p>
                                    <input type="file" id="embFileInputHeatmap" accept=".emb" style="display: none;">
                                    <button class="btn btn-sm btn-primary" id="embBrowseBtnHeatmap">Browse</button>
                                </div>
                                <div id="embFileInfoHeatmap" style="display: none;">
                                    <div class="alert alert-success mt-2 py-2">
                                        <i class="fas fa-check-circle me-1"></i>
                                        <small>Embeddings loaded</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-4">
                            <div class="card-header">
                                <h5 class="mb-0">Category Builder</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="newCategoryName" class="form-label">Category Name:</label>
                                    <input type="text" class="form-control" id="newCategoryName" placeholder="Enter category name">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Add Words:</label>
                                    <div class="word-input">
                                        <input type="text" class="form-control" id="newWord" placeholder="Enter word">
                                        <button class="btn btn-primary" id="addWordBtn">Add</button>
                                    </div>
                                    <div class="word-list" id="wordList">
                                        <div class="empty-state" id="emptyWordList">
                                            <i class="fas fa-plus-circle"></i>
                                            <p>No words added yet</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <button class="btn btn-success w-100" id="saveCategoryBtn">
                                    <i class="fas fa-save me-2"></i>Save Category
                                </button>
                            </div>
                        </div>
                        
                        <div class="card mt-4">
                            <div class="card-header">
                                <h5 class="mb-0">Category Configuration</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="categoryX" class="form-label">X-Axis Category:</label>
                                    <select class="form-select" id="categoryX">
                                        <option value="">Select a category</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="categoryY" class="form-label">Y-Axis Category:</label>
                                    <select class="form-select" id="categoryY">
                                        <option value="">Select a category</option>
                                    </select>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="normalizeData" checked>
                                    <label class="form-check-label" for="normalizeData">
                                        Normalize similarity scores
                                    </label>
                                </div>
                                
                                <button class="btn btn-primary w-100" id="generateHeatmapBtn" disabled>
                                    <i class="fas fa-fire me-2"></i>Generate Heatmap
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Category Management</h5>
                                <button class="btn btn-sm btn-outline-danger" id="clearAllCategoriesBtn">
                                    <i class="fas fa-trash me-1"></i>Clear All
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="categoryManagement" class="category-management">
                                    <div class="empty-state" id="emptyCategories">
                                        <i class="fas fa-folder-open"></i>
                                        <p>No categories created yet</p>
                                        <p class="small">Use the form to create your first category</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-4">
                            <div class="card-header">
                                <h5 class="mb-0">Heatmap Visualization</h5>
                            </div>
                            <div class="card-body">
                                <div id="heatmapInstructions" class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Upload embedding file and create categories to generate heatmap.
                                </div>
                                
                                <div class="mt-4" id="heatmapContainer" style="display: none;">
                                    <div class="results-summary">
                                        <h6>Heatmap Results: <span id="heatmapTitle"></span></h6>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <small><strong>X-Axis:</strong> <span id="categoryXInfo"></span> (<span id="wordXCount">0</span> words)</small>
                                            </div>
                                            <div class="col-md-6">
                                                <small><strong>Y-Axis:</strong> <span id="categoryYInfo"></span> (<span id="wordYCount">0</span> words)</small>
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <small><strong>Similarity Range:</strong> <span id="similarityRange">0.00 - 0.00</span></small>
                                        </div>
                                    </div>
                                    
                                    <div class="heatmap-legend">
                                        <div class="color-scale">
                                            <span>Low</span>
                                            <div class="color-bar"></div>
                                            <span>High</span>
                                        </div>
                                    </div>
                                    
                                    <div class="heatmap-container">
                                        <div id="heatmap"></div>
                                    </div>
                                    
                                    <div class="download-options">
                                        <button class="btn btn-success" id="downloadHeatmapBtn">
                                            <i class="fas fa-download me-2"></i>Download Heatmap (PNG)
                                        </button>
                                        <button class="btn btn-primary" id="downloadMetricsBtn">
                                            <i class="fas fa-file-csv me-2"></i>Download Metrics (CSV)
                                        </button>
                                        <button class="btn btn-outline-primary" id="downloadAllBtn">
                                            <i class="fas fa-file-archive me-2"></i>Download All (ZIP)
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Information Section -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">About Word2Vec</h5>
                    </div>
                    <div class="card-body">
                        <p>Word2Vec is a technique for natural language processing that uses a neural network model to learn word associations from a large corpus of text.</p>
                        <p>This tool processes your text documents through the following steps:</p>
                        <ol>
                            <li>Text extraction from PDF files (if applicable)</li>
                            <li>Text preprocessing and cleaning</li>
                            <li>Tokenization and phrase extraction</li>
                            <li>Word2Vec model training</li>
                            <li>Vector and phrase frequency export</li>
                        </ol>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Output Files</h5>
                    </div>
                    <div class="card-body">
                        <p>After processing, you'll receive two main output files:</p>
                        <ul>
                            <li><strong>phrase_counts.csv</strong> - Contains all extracted phrases and their frequencies</li>
                            <li><strong>word_vectors.emb</strong> - Contains the trained word vectors in Word2Vec format</li>
                        </ul>
                        <p>These files can be used for various NLP tasks such as:</p>
                        <ul>
                            <li>Semantic similarity analysis</li>
                            <li>Document classification</li>
                            <li>Keyword extraction</li>
                            <li>Topic modeling</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer mt-5">
        <div class="container">
            <p>Word2Vec Training & Analysis Tool &copy; 2025 | Johannesburg Business School</p>
        </div>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM elements
            const elements = {
                // Training Tab
                uploadArea: document.getElementById('uploadArea'),
                fileInput: document.getElementById('fileInput'),
                browseBtn: document.getElementById('browseBtn'),
                fileListContainer: document.getElementById('fileListContainer'),
                fileList: document.getElementById('fileList'),
                processBtn: document.getElementById('processBtn'),
                resetBtn: document.getElementById('resetBtn'),
                processingStep: document.getElementById('processingStep'),
                resultsStep: document.getElementById('resultsStep'),
                progressBar: document.getElementById('progressBar'),
                processingStatus: document.getElementById('processingStatus'),
                downloadBtn: document.getElementById('downloadBtn'),
                previewResultsBtn: document.getElementById('previewResultsBtn'),
                
                // Analysis Tab
                embUploadArea: document.getElementById('embUploadArea'),
                embFileInput: document.getElementById('embFileInput'),
                embBrowseBtn: document.getElementById('embBrowseBtn'),
                embFileInfo: document.getElementById('embFileInfo'),
                embFileName: document.getElementById('embFileName'),
                wordCount: document.getElementById('wordCount'),
                searchWord: document.getElementById('searchWord'),
                searchBtn: document.getElementById('searchBtn'),
                similarityResults: document.getElementById('similarityResults'),
                similarWordsList: document.getElementById('similarWordsList'),
                word1: document.getElementById('word1'),
                word2: document.getElementById('word2'),
                word3: document.getElementById('word3'),
                visualizeBtn: document.getElementById('visualizeBtn'),
                visualizationContainer: document.getElementById('visualizationContainer'),
                
                // Heatmap Tab
                embUploadAreaHeatmap: document.getElementById('embUploadAreaHeatmap'),
                embFileInputHeatmap: document.getElementById('embFileInputHeatmap'),
                embBrowseBtnHeatmap: document.getElementById('embBrowseBtnHeatmap'),
                embFileInfoHeatmap: document.getElementById('embFileInfoHeatmap'),
                newCategoryName: document.getElementById('newCategoryName'),
                newWord: document.getElementById('newWord'),
                addWordBtn: document.getElementById('addWordBtn'),
                wordList: document.getElementById('wordList'),
                emptyWordList: document.getElementById('emptyWordList'),
                saveCategoryBtn: document.getElementById('saveCategoryBtn'),
                categoryManagement: document.getElementById('categoryManagement'),
                emptyCategories: document.getElementById('emptyCategories'),
                clearAllCategoriesBtn: document.getElementById('clearAllCategoriesBtn'),
                categoryX: document.getElementById('categoryX'),
                categoryY: document.getElementById('categoryY'),
                generateHeatmapBtn: document.getElementById('generateHeatmapBtn'),
                heatmapInstructions: document.getElementById('heatmapInstructions'),
                heatmapContainer: document.getElementById('heatmapContainer'),
                heatmapTitle: document.getElementById('heatmapTitle'),
                categoryXInfo: document.getElementById('categoryXInfo'),
                categoryYInfo: document.getElementById('categoryYInfo'),
                wordXCount: document.getElementById('wordXCount'),
                wordYCount: document.getElementById('wordYCount'),
                similarityRange: document.getElementById('similarityRange'),
                heatmap: document.getElementById('heatmap'),
                downloadHeatmapBtn: document.getElementById('downloadHeatmapBtn'),
                downloadMetricsBtn: document.getElementById('downloadMetricsBtn'),
                downloadAllBtn: document.getElementById('downloadAllBtn'),
                normalizeData: document.getElementById('normalizeData')
            };

            // Global variables
            let selectedFiles = [];
            let categories = {};
            let processingInterval = null;
            let currentWordVectors = null;
            let currentWords = [];

            // Initialize tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Event listeners for Training Tab
            elements.browseBtn.addEventListener('click', () => elements.fileInput.click());
            elements.fileInput.addEventListener('change', handleFileSelect);
            elements.uploadArea.addEventListener('dragover', handleDragOver);
            elements.uploadArea.addEventListener('dragleave', handleDragLeave);
            elements.uploadArea.addEventListener('drop', handleFileDrop);
            elements.processBtn.addEventListener('click', processFiles);
            elements.resetBtn.addEventListener('click', resetApp);
            elements.downloadBtn.addEventListener('click', downloadResults);
            elements.previewResultsBtn.addEventListener('click', previewResults);

            // Event listeners for Analysis Tab
            elements.embBrowseBtn.addEventListener('click', () => elements.embFileInput.click());
            elements.embFileInput.addEventListener('change', handleEmbFileSelect);
            elements.embUploadArea.addEventListener('dragover', handleDragOver);
            elements.embUploadArea.addEventListener('dragleave', handleDragLeave);
            elements.embUploadArea.addEventListener('drop', handleEmbFileDrop);
            elements.searchBtn.addEventListener('click', searchSimilarWords);
            elements.visualizeBtn.addEventListener('click', visualizeSimilarity);

            // Event listeners for Heatmap Tab
            elements.embBrowseBtnHeatmap.addEventListener('click', () => elements.embFileInputHeatmap.click());
            elements.embFileInputHeatmap.addEventListener('change', handleEmbFileSelectHeatmap);
            elements.embUploadAreaHeatmap.addEventListener('dragover', handleDragOver);
            elements.embUploadAreaHeatmap.addEventListener('dragleave', handleDragLeave);
            elements.embUploadAreaHeatmap.addEventListener('drop', handleEmbFileDropHeatmap);
            
            elements.addWordBtn.addEventListener('click', addWord);
            elements.newWord.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addWord();
                }
            });
            
            elements.saveCategoryBtn.addEventListener('click', saveCategory);
            elements.clearAllCategoriesBtn.addEventListener('click', clearAllCategories);
            elements.generateHeatmapBtn.addEventListener('click', generateHeatmap);
            elements.downloadHeatmapBtn.addEventListener('click', downloadHeatmap);
            elements.downloadMetricsBtn.addEventListener('click', downloadMetrics);
            elements.downloadAllBtn.addEventListener('click', downloadAllHeatmap);

            // File handling functions
            function handleFileSelect(e) {
                const files = e.target.files;
                addFiles(files);
            }

            function handleDragOver(e) {
                e.preventDefault();
                e.currentTarget.classList.add('dragover');
            }

            function handleDragLeave(e) {
                e.preventDefault();
                e.currentTarget.classList.remove('dragover');
            }

            function handleFileDrop(e) {
                e.preventDefault();
                e.currentTarget.classList.remove('dragover');
                const files = e.dataTransfer.files;
                addFiles(files);
            }

            function handleEmbFileDrop(e) {
                e.preventDefault();
                e.currentTarget.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleEmbFile(files[0], 'analysis');
                }
            }

            function handleEmbFileDropHeatmap(e) {
                e.preventDefault();
                e.currentTarget.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleEmbFile(files[0], 'heatmap');
                }
            }

            function addFiles(files) {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    if (selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
                        continue;
                    }
                    
                    if (!file.name.toLowerCase().endsWith('.txt') && !file.name.toLowerCase().endsWith('.pdf')) {
                        alert('Only .txt and .pdf files are allowed.');
                        continue;
                    }
                    
                    selectedFiles.push(file);
                    
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <div>
                            <i class="fas ${file.name.toLowerCase().endsWith('.pdf') ? 'fa-file-pdf text-danger' : 'fa-file-alt text-primary'} me-2"></i>
                            ${file.name}
                        </div>
                        <div>
                            <small class="text-muted me-2">${formatFileSize(file.size)}</small>
                            <button class="btn btn-sm btn-outline-danger remove-file" data-index="${selectedFiles.length - 1}">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    elements.fileList.appendChild(fileItem);
                }
                
                if (selectedFiles.length > 0) {
                    elements.fileListContainer.style.display = 'block';
                    elements.processBtn.disabled = false;
                    elements.resetBtn.disabled = false;
                }
                
                document.querySelectorAll('.remove-file').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        removeFile(index);
                    });
                });
            }

            function removeFile(index) {
                selectedFiles.splice(index, 1);
                updateFileList();
            }

            function updateFileList() {
                elements.fileList.innerHTML = '';
                
                selectedFiles.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <div>
                            <i class="fas ${file.name.toLowerCase().endsWith('.pdf') ? 'fa-file-pdf text-danger' : 'fa-file-alt text-primary'} me-2"></i>
                            ${file.name}
                        </div>
                        <div>
                            <small class="text-muted me-2">${formatFileSize(file.size)}</small>
                            <button class="btn btn-sm btn-outline-danger remove-file" data-index="${index}">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    elements.fileList.appendChild(fileItem);
                });
                
                document.querySelectorAll('.remove-file').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        removeFile(index);
                    });
                });
                
                if (selectedFiles.length === 0) {
                    elements.fileListContainer.style.display = 'none';
                    elements.processBtn.disabled = true;
                    elements.resetBtn.disabled = true;
                }
            }

            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            // Process files for Training Tab
            function processFiles() {
                if (selectedFiles.length === 0) {
                    alert('Please select at least one file to process.');
                    return;
                }
                
                elements.processingStep.style.display = 'flex';
                elements.processBtn.disabled = true;
                elements.resetBtn.disabled = true;
                
                const formData = new FormData();
                selectedFiles.forEach(file => {
                    formData.append('files', file);
                });
                
                simulateProgress();
                
                fetch('/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    clearInterval(processingInterval);
                    
                    if (!response.ok) {
                        return response.json().then(err => { 
                            throw new Error(err.error || 'Server error occurred');
                        });
                    }
                    
                    elements.progressBar.style.width = '100%';
                    elements.processingStatus.innerHTML = '<div class="text-success"><i class="fas fa-check-circle me-2"></i>Processing complete! Preparing download...</div>';
                    
                    return response.blob();
                })
                .then(blob => {
                    window.resultBlob = blob;
                    
                    setTimeout(() => {
                        elements.processingStep.style.display = 'none';
                        elements.resultsStep.style.display = 'flex';
                    }, 1000);
                })
                .catch(error => {
                    console.error('Error:', error);
                    clearInterval(processingInterval);
                    elements.processingStatus.innerHTML = `<div class="text-danger"><i class="fas fa-exclamation-circle me-2"></i>Error: ${error.message}</div>`;
                    elements.processBtn.disabled = false;
                    elements.resetBtn.disabled = false;
                });
            }

            function simulateProgress() {
                let progress = 0;
                processingInterval = setInterval(() => {
                    progress += 2;
                    if (progress <= 90) {
                        elements.progressBar.style.width = `${progress}%`;
                        
                        if (progress < 30) {
                            elements.processingStatus.innerHTML = '<div class="d-flex align-items-center"><div class="spinner-border text-primary me-2" role="status"></div><span>Extracting text from files...</span></div>';
                        } else if (progress < 60) {
                            elements.processingStatus.innerHTML = '<div class="d-flex align-items-center"><div class="spinner-border text-primary me-2" role="status"></div><span>Preprocessing text...</span></div>';
                        } else {
                            elements.processingStatus.innerHTML = '<div class="d-flex align-items-center"><div class="spinner-border text-primary me-2" role="status"></div><span>Training Word2Vec model...</span></div>';
                        }
                    } else {
                        clearInterval(processingInterval);
                    }
                }, 500);
            }

            function downloadResults() {
                if (window.resultBlob) {
                    const url = URL.createObjectURL(window.resultBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'word2vec_results.zip';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } else {
                    alert('No results available to download.');
                }
            }

            function previewResults() {
                if (window.resultBlob) {
                    alert('Results preview would show sample data here. In a full implementation, this would display the first few rows of each file.');
                } else {
                    alert('No results available to preview.');
                }
            }

            function resetApp() {
                selectedFiles = [];
                elements.fileList.innerHTML = '';
                elements.fileListContainer.style.display = 'none';
                elements.processingStep.style.display = 'none';
                elements.resultsStep.style.display = 'none';
                elements.processBtn.disabled = true;
                elements.resetBtn.disabled = true;
                elements.progressBar.style.width = '0%';
                elements.processingStatus.innerHTML = '<div class="d-flex align-items-center"><div class="spinner-border text-primary me-2" role="status"></div><span>Initializing...</span></div>';
                elements.fileInput.value = '';
                
                if (processingInterval) {
                    clearInterval(processingInterval);
                    processingInterval = null;
                }
                
                window.resultBlob = null;
            }

            // Analysis Tab functions
            function handleEmbFileSelect(e) {
                const file = e.target.files[0];
                if (file) {
                    handleEmbFile(file, 'analysis');
                }
            }

            function handleEmbFileSelectHeatmap(e) {
                const file = e.target.files[0];
                if (file) {
                    handleEmbFile(file, 'heatmap');
                }
            }

            function handleEmbFile(file, tab) {
                if (!file.name.toLowerCase().endsWith('.emb')) {
                    alert('Please upload a .emb file.');
                    return;
                }
                
                const formData = new FormData();
                formData.append('emb_file', file);
                
                fetch('/analyze/load_embeddings', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    currentWordVectors = data.word_vectors;
                    
                    if (tab === 'analysis') {
                        window.embFile = file;
                        elements.embFileName.textContent = file.name;
                        elements.wordCount.textContent = Object.keys(currentWordVectors).length;
                        elements.embFileInfo.style.display = 'block';
                        elements.searchBtn.disabled = false;
                        elements.visualizeBtn.disabled = false;
                    } else {
                        elements.embFileInfoHeatmap.style.display = 'block';
                        updateGenerateButtonState();
                    }
                    
                    showNotification(`Word vectors loaded successfully! ${Object.keys(currentWordVectors).length} words available.`, 'success');
                })
                .catch(error => {
                    showNotification('Error loading embeddings: ' + error.message, 'error');
                });
            }

            function searchSimilarWords() {
                const word = elements.searchWord.value.trim().toLowerCase();
                if (!word) {
                    alert('Please enter a word to search.');
                    return;
                }
                
                if (!currentWordVectors) {
                    alert('Please upload an embedding file first.');
                    return;
                }
                
                if (!currentWordVectors[word]) {
                    alert(`Word "${word}" not found in the vector space.`);
                    return;
                }
                
                elements.searchBtn.disabled = true;
                elements.searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Searching...';
                
                fetch('/analyze/similarity', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        word: word,
                        word_vectors: currentWordVectors
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    elements.similarWordsList.innerHTML = '';
                    data.similar_words.forEach(item => {
                        const similarityItem = document.createElement('div');
                        similarityItem.className = 'result-item';
                        similarityItem.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="word-similarity">${item.word}</span>
                                <div>
                                    <span class="badge bg-primary me-2">${item.similarity.toFixed(4)}</span>
                                    <div class="progress" style="width: 100px; height: 8px;">
                                        <div class="progress-bar" role="progressbar" style="width: ${item.similarity * 100}%"></div>
                                    </div>
                                </div>
                            </div>
                        `;
                        elements.similarWordsList.appendChild(similarityItem);
                    });
                    
                    elements.similarityResults.style.display = 'block';
                })
                .catch(error => {
                    showNotification('Error: ' + error.message, 'error');
                })
                .finally(() => {
                    elements.searchBtn.disabled = false;
                    elements.searchBtn.innerHTML = 'Search';
                });
            }

            function visualizeSimilarity() {
                const words = [
                    elements.word1.value.trim().toLowerCase(), 
                    elements.word2.value.trim().toLowerCase(), 
                    elements.word3.value.trim().toLowerCase()
                ].filter(w => w);
                
                if (words.length < 2) {
                    alert('Please enter at least two words.');
                    return;
                }
                
                if (!currentWordVectors) {
                    alert('Please upload an embedding file first.');
                    return;
                }
                
                const missingWords = words.filter(word => !currentWordVectors[word]);
                if (missingWords.length > 0) {
                    alert(`The following words were not found: ${missingWords.join(', ')}`);
                    return;
                }
                
                elements.visualizeBtn.disabled = true;
                elements.visualizeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
                
                fetch('/analyze/visualize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        words: words,
                        word_vectors: currentWordVectors
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    const ctx = document.getElementById('similarityChart').getContext('2d');
                    
                    if (window.similarityChartInstance) {
                        window.similarityChartInstance.destroy();
                    }
                    
                    // Prepare data for chart
                    const labels = data.similarities.map(item => {
                        const words = item.pair.split(' - ');
                        return `${words[0]}\n${words[1]}`;
                    });
                    const similarities = data.similarities.map(item => item.similarity);
                    
                    // Create gradient for bars
                    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                    gradient.addColorStop(0, 'rgba(78, 115, 223, 1)');
                    gradient.addColorStop(1, 'rgba(78, 115, 223, 0.6)');
                    
                    window.similarityChartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Cosine Similarity',
                                data: similarities,
                                backgroundColor: gradient,
                                borderColor: 'rgba(78, 115, 223, 1)',
                                borderWidth: 1,
                                borderRadius: 5,
                                borderSkipped: false,
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `Similarity: ${context.parsed.y.toFixed(4)}`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 1.0,
                                    title: {
                                        display: true,
                                        text: 'Cosine Similarity'
                                    },
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.1)'
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false
                                    },
                                    ticks: {
                                        maxRotation: 45,
                                        minRotation: 45
                                    }
                                }
                            }
                        }
                    });
                    
                    elements.visualizationContainer.style.display = 'block';
                })
                .catch(error => {
                    showNotification('Error: ' + error.message, 'error');
                })
                .finally(() => {
                    elements.visualizeBtn.disabled = false;
                    elements.visualizeBtn.innerHTML = 'Visualize Similarity';
                });
            }

            // Heatmap Tab functions - Category Builder
            function addWord() {
                const word = elements.newWord.value.trim().toLowerCase();
                if (!word) {
                    alert('Please enter a word.');
                    return;
                }
                
                if (currentWords.includes(word)) {
                    alert('This word is already in the list.');
                    return;
                }
                
                currentWords.push(word);
                updateWordList();
                elements.newWord.value = '';
                elements.newWord.focus();
            }

            function updateWordList() {
                if (currentWords.length === 0) {
                    elements.emptyWordList.style.display = 'block';
                    elements.wordList.innerHTML = '';
                    elements.wordList.appendChild(elements.emptyWordList);
                } else {
                    elements.emptyWordList.style.display = 'none';
                    elements.wordList.innerHTML = '';
                    
                    currentWords.forEach((word, index) => {
                        const wordTag = document.createElement('span');
                        wordTag.className = 'word-tag';
                        wordTag.innerHTML = `
                            ${word}
                            <span class="remove" data-index="${index}">
                                <i class="fas fa-times"></i>
                            </span>
                        `;
                        elements.wordList.appendChild(wordTag);
                    });
                    
                    // Add event listeners to remove buttons
                    elements.wordList.querySelectorAll('.remove').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const index = parseInt(this.getAttribute('data-index'));
                            currentWords.splice(index, 1);
                            updateWordList();
                        });
                    });
                }
            }

            function saveCategory() {
                const categoryName = elements.newCategoryName.value.trim();
                if (!categoryName) {
                    alert('Please enter a category name.');
                    return;
                }
                
                if (currentWords.length === 0) {
                    alert('Please add at least one word to the category.');
                    return;
                }
                
                if (categories[categoryName]) {
                    alert('A category with this name already exists.');
                    return;
                }
                
                // Save category
                categories[categoryName] = [...currentWords];
                
                // Update UI
                updateCategoryManagement();
                updateCategoryDropdowns();
                
                // Reset form
                elements.newCategoryName.value = '';
                currentWords = [];
                updateWordList();
                
                showNotification(`Category "${categoryName}" saved with ${categories[categoryName].length} words.`, 'success');
            }

            function updateCategoryManagement() {
                if (Object.keys(categories).length === 0) {
                    elements.emptyCategories.style.display = 'block';
                    elements.categoryManagement.innerHTML = '';
                    elements.categoryManagement.appendChild(elements.emptyCategories);
                } else {
                    elements.emptyCategories.style.display = 'none';
                    elements.categoryManagement.innerHTML = '';
                    
                    for (const [categoryName, words] of Object.entries(categories)) {
                        const categoryCard = document.createElement('div');
                        categoryCard.className = 'category-card';
                        categoryCard.innerHTML = `
                            <div class="category-header">
                                <h6 class="mb-0">${categoryName}</h6>
                                <button class="btn btn-sm btn-outline-danger delete-category" data-category="${categoryName}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="category-words">
                                ${words.map(word => `<span class="word-tag">${word}</span>`).join('')}
                            </div>
                        `;
                        elements.categoryManagement.appendChild(categoryCard);
                    }
                    
                    // Add event listeners to delete buttons
                    elements.categoryManagement.querySelectorAll('.delete-category').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const categoryName = this.getAttribute('data-category');
                            deleteCategory(categoryName);
                        });
                    });
                }
            }

            function deleteCategory(categoryName) {
                if (confirm(`Are you sure you want to delete the category "${categoryName}"?`)) {
                    delete categories[categoryName];
                    updateCategoryManagement();
                    updateCategoryDropdowns();
                    showNotification(`Category "${categoryName}" deleted.`, 'success');
                }
            }

            function clearAllCategories() {
                if (Object.keys(categories).length === 0) {
                    alert('No categories to clear.');
                    return;
                }
                
                if (confirm('Are you sure you want to delete all categories?')) {
                    categories = {};
                    updateCategoryManagement();
                    updateCategoryDropdowns();
                    showNotification('All categories cleared.', 'success');
                }
            }

            function updateCategoryDropdowns() {
                elements.categoryX.innerHTML = '<option value="">Select a category</option>';
                elements.categoryY.innerHTML = '<option value="">Select a category</option>';
                
                for (const categoryName in categories) {
                    const optionX = document.createElement('option');
                    optionX.value = categoryName;
                    optionX.textContent = categoryName;
                    elements.categoryX.appendChild(optionX);
                    
                    const optionY = document.createElement('option');
                    optionY.value = categoryName;
                    optionY.textContent = categoryName;
                    elements.categoryY.appendChild(optionY);
                }
                
                updateGenerateButtonState();
            }

            function updateGenerateButtonState() {
                const hasEmbeddings = currentWordVectors !== null;
                const hasCategories = Object.keys(categories).length > 0;
                const hasSelectedCategories = elements.categoryX.value && elements.categoryY.value;
                
                elements.generateHeatmapBtn.disabled = !(hasEmbeddings && hasCategories && hasSelectedCategories);
            }

            // Add event listeners for category changes
            elements.categoryX.addEventListener('change', updateGenerateButtonState);
            elements.categoryY.addEventListener('change', updateGenerateButtonState);

            function generateHeatmap() {
                const catX = elements.categoryX.value;
                const catY = elements.categoryY.value;
                const normalize = elements.normalizeData.checked;
                
                if (!catX || !catY) {
                    alert('Please select both categories.');
                    return;
                }
                
                if (!currentWordVectors) {
                    alert('Please upload an embedding file first.');
                    return;
                }
                
                if (Object.keys(categories).length === 0) {
                    alert('Please create at least one category.');
                    return;
                }
                
                elements.generateHeatmapBtn.disabled = true;
                elements.generateHeatmapBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
                
                fetch('/heatmap/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        category_x: catX,
                        category_y: catY,
                        categories: categories,
                        word_vectors: currentWordVectors,
                        normalize: normalize
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    displayHeatmap(data);
                    window.heatmapData = data;
                    
                    elements.heatmapInstructions.style.display = 'none';
                    elements.heatmapContainer.style.display = 'block';
                })
                .catch(error => {
                    showNotification('Error: ' + error.message, 'error');
                })
                .finally(() => {
                    elements.generateHeatmapBtn.disabled = false;
                    elements.generateHeatmapBtn.innerHTML = '<i class="fas fa-fire me-2"></i>Generate Heatmap';
                });
            }

            function displayHeatmap(data) {
                const { category_x, category_y, words_x, words_y, matrix, stats } = data;
                
                // Update summary information
                elements.heatmapTitle.textContent = `${category_x} vs ${category_y}`;
                elements.categoryXInfo.textContent = category_x;
                elements.categoryYInfo.textContent = category_y;
                elements.wordXCount.textContent = words_x.length;
                elements.wordYCount.textContent = words_y.length;
                elements.similarityRange.textContent = `${stats.min.toFixed(3)} - ${stats.max.toFixed(3)}`;
                
                // Generate heatmap HTML
                let heatmapHTML = '<table class="heatmap">';
                
                // Header row (Y category words)
                heatmapHTML += '<tr><th class="heatmap-header"></th>';
                for (const wordY of words_y) {
                    heatmapHTML += `<th class="heatmap-header" title="${wordY}">${truncateText(wordY, 10)}</th>`;
                }
                heatmapHTML += '</tr>';
                
                // Data rows
                for (let i = 0; i < words_x.length; i++) {
                    heatmapHTML += `<tr><th class="heatmap-header" title="${words_x[i]}">${truncateText(words_x[i], 10)}</th>`;
                    for (let j = 0; j < words_y.length; j++) {
                        const similarity = matrix[i][j];
                        const normalizedValue = (similarity - stats.min) / (stats.max - stats.min);
                        const color = getColorForValue(normalizedValue);
                        const brightness = normalizedValue > 0.5 ? 'white' : 'black';
                        
                        heatmapHTML += `<td class="heatmap-cell" style="background-color: ${color}; color: ${brightness}" 
                                            data-bs-toggle="tooltip" data-bs-placement="top" 
                                            title="${words_x[i]} - ${words_y[j]}: ${similarity.toFixed(4)}">
                                            ${similarity.toFixed(2)}
                                        </td>`;
                    }
                    heatmapHTML += '</tr>';
                }
                
                heatmapHTML += '</table>';
                elements.heatmap.innerHTML = heatmapHTML;
                
                // Reinitialize tooltips for new elements
                const newTooltipTriggerList = [].slice.call(elements.heatmap.querySelectorAll('[data-bs-toggle="tooltip"]'));
                newTooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            }

            function getColorForValue(value) {
                // Create a blue gradient from light to dark
                const hue = 210; // Blue hue
                const saturation = 70;
                const lightness = 90 - (value * 40); // From light (90) to dark (50)
                return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
            }

            function truncateText(text, maxLength) {
                if (text.length <= maxLength) return text;
                return text.substring(0, maxLength) + '...';
            }

            function downloadHeatmap() {
                if (!window.heatmapData) {
                    alert('No heatmap data available.');
                    return;
                }
                
                // Create a canvas element to render the heatmap
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const { words_x, words_y, matrix, stats } = window.heatmapData;
                
                // Set canvas size with better spacing
                const cellSize = 60;
                const headerSize = 80;
                canvas.width = (words_y.length * cellSize) + headerSize;
                canvas.height = (words_x.length * cellSize) + headerSize;
                
                // Draw background
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw headers with better styling
                ctx.fillStyle = '#4e73df';
                ctx.font = 'bold 12px Arial';
                
                // Y-axis headers (vertical)
                ctx.save();
                ctx.translate(20, headerSize + (cellSize / 2));
                for (let i = 0; i < words_x.length; i++) {
                    ctx.save();
                    ctx.rotate(-Math.PI / 2);
                    ctx.fillText(truncateText(words_x[i], 15), 0, 0);
                    ctx.restore();
                    ctx.translate(0, cellSize);
                }
                ctx.restore();
                
                // X-axis headers
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                for (let j = 0; j < words_y.length; j++) {
                    ctx.fillText(truncateText(words_y[j], 15), headerSize + (j * cellSize) + (cellSize / 2), headerSize / 2);
                }
                
                // Draw heatmap cells
                for (let i = 0; i < words_x.length; i++) {
                    for (let j = 0; j < words_y.length; j++) {
                        const similarity = matrix[i][j];
                        const normalizedValue = (similarity - stats.min) / (stats.max - stats.min);
                        const color = getColorForValue(normalizedValue);
                        
                        ctx.fillStyle = color;
                        ctx.fillRect(headerSize + (j * cellSize), headerSize + (i * cellSize), cellSize, cellSize);
                        
                        // Draw similarity value
                        ctx.fillStyle = normalizedValue > 0.5 ? 'white' : 'black';
                        ctx.font = '10px Arial';
                        ctx.fillText(
                            similarity.toFixed(2),
                            headerSize + (j * cellSize) + (cellSize / 2),
                            headerSize + (i * cellSize) + (cellSize / 2)
                        );
                        
                        // Draw cell border
                        ctx.strokeStyle = '#e3e6f0';
                        ctx.strokeRect(headerSize + (j * cellSize), headerSize + (i * cellSize), cellSize, cellSize);
                    }
                }
                
                // Add title
                ctx.fillStyle = '#2e59d9';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${window.heatmapData.category_x} vs ${window.heatmapData.category_y} Heatmap`, canvas.width / 2, 25);
                
                // Create download link
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `heatmap_${window.heatmapData.category_x}_${window.heatmapData.category_y}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 'image/png');
            }

            function downloadMetrics() {
                if (!window.heatmapData) {
                    alert('No heatmap data available.');
                    return;
                }
                
                const { category_x, category_y, words_x, words_y, matrix } = window.heatmapData;
                
                // Create CSV content
                let csvContent = 'Category X,Category Y,Word X,Word Y,Similarity\n';
                
                for (let i = 0; i < words_x.length; i++) {
                    for (let j = 0; j < words_y.length; j++) {
                        csvContent += `"${category_x}","${category_y}","${words_x[i]}","${words_y[j]}",${matrix[i][j].toFixed(6)}\n`;
                    }
                }
                
                // Create download link
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `heatmap_metrics_${category_x}_${category_y}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            function downloadAllHeatmap() {
                if (!window.heatmapData) {
                    alert('No heatmap data available.');
                    return;
                }
                
                // In a real implementation, this would send a request to the backend
                // to create a ZIP file containing both the PNG and CSV
                alert('In a full implementation, this would download a ZIP file containing both the heatmap image and metrics CSV. For now, please use the individual download buttons.');
            }

            // Utility functions
            function showNotification(message, type = 'info') {
                // Create a simple notification
                const alertClass = type === 'error' ? 'alert-danger' : type === 'success' ? 'alert-success' : 'alert-info';
                const notification = document.createElement('div');
                notification.className = `alert ${alertClass} alert-dismissible fade show`;
                notification.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                // Add to page (you might want to create a specific container for notifications)
                document.body.appendChild(notification);
                
                // Auto remove after 5 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 5000);
            }

            // Initialize category dropdown event listeners
            elements.categoryX.addEventListener('change', updateGenerateButtonState);
            elements.categoryY.addEventListener('change', updateGenerateButtonState);
        });
    </script>
</body>
</html>